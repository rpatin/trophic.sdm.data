## --------------------------------------------------------------------------- #
# 1. trophic_dataset         ---------------------------------------------------
## --------------------------------------------------------------------------- #

##' @name trophic_dataset
##' @aliases trophic_dataset-class
##' @author Remi Patin
##'
##' @title Dataset for running trophic SDM
##'
##' @description Class returned by \code{\link{prepare_dataset_gbif}} and
##'   \code{\link{prepare_dataset_iucn}}, that prepare a dataset for a trophic
##'   SDM, based on a gbif or IUCN workflow.
##'
##' @inheritParams gbif_outsider
##' @inheritParams taxonomic_conflict
##' @inheritParams sampling_effort
##' @inheritParams rasterize_iucn
##' @param sampling.effort a \code{\link{sampling_effort}} object, generated by
##'   \code{\link{calc_sampling_effort}} containing several layers of sampling
##'   effort based on taxonomic group and the association between species and
##'   the sampling effort layer
##' @param min.gbif a \code{numeric} (\emph{default} \code{25}), the minimum
##'   number of gbif occurrences below which a species is filtered.
##' @param folder.iucn.buffer a \code{character}, folder in which IUCN buffered range
##' are stored as raster files.
##' @param quantile.absence.certain a \code{numeric} (\emph{default}
##'   \code{0.1}), between 0 and 1. The quantile of sampling effort below which
##'   a species absence is considered as uncertain
##' @param prop.prey.certain a \code{numeric} (\emph{default} \code{0.8}),
##'   between 0 and 1. The minimum proportion of prey occurrence considered as
##'   certain for a raster cell to be included in the species dataset.
##' @param uncertain.value a \code{integer} (\code{0} or \code{1} ;
##'   \emph{default} \code{0}). The value given to uncertain absences in cells
##'   where more than \code{prop.prey.certain} prey are considered as certain.
##' @param ... additional parameter given to \code{\link{filter_dataset}} to
##'   filter the dataset at the end of the workflow.
##' @param min.presence a \code{integer} used as a filtering parameter. Any 
##' species with less presence than \code{min.presence} in its trophic dataset
##' is removed.
##' @param min.absence a \code{integer} used as a filtering parameter. Any 
##' species with less absence than \code{min.absence} in its trophic dataset
##' is removed.
##' @param subsample.min.prevalence a \code{numeric} used as a subsampling
##'  parameter. Used to subsample absences in trophic dataset with prevalence below 
##'  \code{subsample.min.prevalence}.
##' @param subsample.max.absence a \code{numeric} used as a subsampling
##'  parameter. Used to subsample absences in trophic dataset with more absences 
##'  than \code{subsample.max.absence}.
##' @param min.prevalence.prey a \code{numeric} used as a filtering parameter. Any 
##' prey  with a prevalence in predator presence cell below 
##' \code{min.prevalence.prey}  is removed from the predator dataset.
##' @param min.absence.prey a \code{integer} used as a filtering parameter. Any 
##' prey less absence than \code{min.absence.prey} is removed from the predator
##'  dataset.
##' @slot summary.occurrence a \code{data.frame} with the list of species and 
##' the total number of presence and absence in the occurrence dataset extracted
##' from gbif and independently of prey cell selection.
##' @slot summary.predator a \code{data.frame} with a summary of the actual 
##' trophic dataset, i.e. list of species and the total number of presence 
##' and absence inside/outside IUCN range as well as additional information 
##' such as the number of prey.
##' @slot summary.prey a \code{data.frame} with a summary of occurrence and 
##' prevalence for all prey associated to a predator dataset.
##' @slot file.occurrence.link a named \code{vector} with a path to raw 
##' occurrence data for each species.
##' @slot file.trophic.link  a named \code{vector} with a path to filtered
##' trophic data for each species.
##' @slot metaweb.filtered a \code{data.frame} with all species interactions 
##' that remain after filtering of species and prey.
##' @slot checklist.filtered a \code{data.frame} with information on all species 
##'   that remain after filtering of species.
##' @slot kept.species a \code{character} vector with all species kept
##' @slot filtered.species a named \code{list} vector with all species removed 
##' as well as the motivation of removal
##' @slot kept.prey a named \code{list} with the prey kept for each species
##' @slot filtered.prey a named \code{list} vector with the prey removed for 
##' each species as well as the motivation of removal
##' @slot param.raw a \code{list} with information to regenerate the raw 
##' unfiltered dataset. 
##' @slot param a \code{list} with all parameters used to generate the dataset
##' @slot datatype a \code{character} determining the origin of the dataset:
##' either 'gbif' or 'iucn'.
##' @slot project.name a \code{character} indicating the folder in which
##'   logfiles and data may be written
##' @slot sampling.effort a \code{sampling_effort} object describing the sampling
##' effort associated to all taxa.
##' @slot data.mask a \code{SpatRaster} with the extent and the grid used 
##' in the project
##' 
##' @details 
##' \describe{
##'   \item{gbif dataset (\code{prepare_gbif_dataset})}{ Workflow to prepare gbif
##'   dataset}
##'   \item{IUCN dataset (\code{prepare_iucn_dataset})}{ Workflow to prepare iucn
##'   dataset}
##'   }
##' @examples
##'
##' showClass("trophic_dataset")
NULL

##' @name trophic_dataset-class
##' @rdname trophic_dataset
##' @export
##' @importFrom terra rast

## 1.1 Class Definition ----------------------------------------------------------------------------


setClass("trophic_dataset",
         representation(summary.occurrence = "data.frame",
                        summary.predator = "data.frame",
                        summary.prey = "data.frame",
                        file.occurrence.link = "character",
                        file.trophic.link = "character",
                        metaweb.filtered = "data.frame",
                        checklist.filtered = "data.frame",
                        kept.species = "character",
                        filtered.species = "character",
                        kept.prey = "list",
                        filtered.prey = "list",
                        param.raw = "list",
                        param = "list", 
                        datatype = "character",
                        project.name = "character",
                        sampling.effort = "sampling_effort",
                        data.mask = "SpatRaster"),
         validity = function(object){
           .check_checklist(object@checklist)
           .check_checklist(object@checklist.filtered)
           .check_metaweb(object@metaweb)
           .check_metaweb(object@metaweb.filtered)
           .fun_testIfInherits(object@file.occurrence.link, "character")
           .fun_testIfInherits(object@file.trophic.link, "character")
           .fun_testIfInherits(object@kept.species, "character")
           .fun_testIfInherits(object@filtered.species, "character")
           .fun_testIfInherits(object@param, "list")
           .fun_testIfIn(obejct@datatype, c("iucn","gbif"))
           .fun_testIfInherits(object@data.mask, "SpatRaster")
           .fun_testIfInherits(object@project.name, "character")
           if (!all(c("summary.occurrence.raw",
                      "summary.predator.raw",
                      "summary.prey.raw",
                      "file.trophic.raw.link",
                      "metaweb",
                      "checklist",
                      "kept.species.raw",
                      "filtered.species.raw",
                      "kept.prey.raw",
                      "filtered.prey.raw") %in% names(param.raw))) {
             stop("summary.raw is missing elements")
           }
           TRUE
         })


## 1.2 Methods -------------------------------------------------------------
### show.trophic_dataset    --------------------------------------------------
##'
##' @rdname trophic_dataset
##' @importMethodsFrom methods show
##' @param object an object of class \code{trophic_dataset}
##' @importFrom cli cli_h2 cli_h3 cli_li
##' @export
##'

setMethod('show', signature('trophic_dataset'),
          function(object)
          {
            n.removed <- length(do.call('c', object@filtered.prey))
            n.kept <- length(do.call('c', object@kept.prey))
            n.tot <- n.removed + n.kept
            percent.rm <- round(n.removed/(n.tot)*100, digits = 2)
            param <- object@param
            param.filter <- param$param.filter
            cli_h2("Trophic dataset Summary")
            cli_li("Project: {object@project.name}")
            cli_li("Species kept: {length(object@kept.species)}")
            cli_li("Species removed: {length(object@filtered.species)}")
            cli_li("Species interactions kept: {n.kept}")
            cli_li("Species interactions removed: {percent.rm}%")
            
            cli_h2("Parameters")
            
            cli_h3("Occurrence selection")
            cli_li("Quantile used for evaluating absences as certain = {unique(param$quantile.absence.certain)}")
            
            cli_h3("Species Filtering")
            cli_li("Minimum gbif occurrences = {param$min.gbif}")
            cli_li("Minimum presence in final dataset = {param.filter$min.presence}")
            cli_li("Minimum absence in final dataset = {param.filter$min.absence}")
            
            cli_h3("Prey filtering")
            cli_li("Minimum prey absence  = {param.filter$min.absence.prey}")
            cli_li("Minimum prey prevalence in predator presence cells  = {param.filter$min.prevalence.prey}")
            
            cli_h3("Predator cell selection")
            cli_li("Required proportion of certain prey occurrences = {param$prop.prey.certain*100}%")
            cli_li("Values for uncertain prey cells = {param$uncertain.value}")
            
            cli_h3("Subsampling absences")
            cli_li("Minimum prevalence = {param.filter$subsample.min.prevalence}")
            cli_li("Maximum number of absences = {param.filter$subsample.max.absence}")
            invisible(NULL)
          })




### filter_species    ------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##' @importFrom dplyr select all_of
##'


setGeneric("filter_species", def = function(x, ...) {
  standardGeneric("filter_species") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_alert_success
setMethod('filter_species', signature(x = 'trophic_dataset'),
          function(x,
                   min.presence,
                   min.absence) {
            # browser()
            ### Argument check and setup --------------------------------------
            cli_h2("Parameter check")
            args <- .filter_dataset.check.args(type = "filter_species",
                                               min.presence = min.presence,
                                               min.absence = min.absence)
            
            for (argi in names(args)) { assign(x = argi, value = args[[argi]]) }
            
            x@param$param.filter$min.presence <- min.presence
            x@param$param.filter$min.absence <- min.absence
            
            # setup dir
            project.name <- x@project.name
            folder.names <- set_folder(project.name)
            for (argi in names(folder.names)) { assign(x = argi, value = folder.names[[argi]]) }
            
            # code-name converter
            listcode.full <- checklist$Code
            names(listcode.full) <- checklist$SpeciesName
            listname.full <- checklist$SpeciesName
            names(listname.full) <- checklist$Code
            
            ### Filtering Species ----------------------------------------------
            if (min.presence > 0 || min.absence > 0) {
              cli_h2("Filter species")
              cli_alert_info("Remove species with less then {min.presence} presence \\
                     or less than {min.absence} absence")
              # browser()
              summary.occurrence <- x@summary.predator %>% 
                filter(presence < min.presence |
                         absence_tot < min.absence)
              if (nrow(summary.occurrence) == 0) {
                cli_alert_success("No species to remove")
              } else {
                for (this.species in summary.occurrence$SpeciesName) {
                  cli_progress_step("Removing {this.species}")
                  # browser()
                  this.reason <- "Not enough data after rasterization and prey filtering"
                  names(this.reason) <- this.species
                  this.code <- listcode.full[this.species]
                  
                  x@summary.occurrence <- 
                    x@summary.occurrence %>% 
                    filter(SpeciesName != this.species)
                  
                  x@summary.predator <- 
                    x@summary.predator %>% 
                    filter(SpeciesName != this.species)
                  
                  # Remove species in predator dataset
                  if ( nrow(x@summary.prey) == 0 ) {
                    summary.prey.rm <- data.frame()
                  } else {
                    summary.prey.rm <-  
                      x@summary.prey %>% 
                      filter(Prey_Code == this.code)
                  }
                  if (nrow(summary.prey.rm) > 0) {
                    for (this.pred in summary.prey.rm$SpeciesName) {
                      this.trophic <- fread(x@file.trophic.link[this.pred])
                      this.trophic <- 
                        this.trophic %>%
                        select(-all_of(this.code))
                      this.index <- which(x@summary.predator$SpeciesName == this.pred)
                      x@summary.predator$nprey[this.index] <- 
                        x@summary.predator$nprey[this.index] - 1
                      this.file <- paste0(dataset.dir,listcode.full[this.pred],".csv.gz")
                      fwrite(this.trophic, file = this.file)  
                      x@file.trophic.link[this.pred] <- this.file
                      x@kept.prey[[this.pred]] <- 
                        x@kept.prey[[this.pred]][
                          x@kept.prey[[this.pred]] != this.species
                        ]
                      this.prey.reason <- "Not enough data after rasterization"
                      names(this.prey.reason) <- this.species
                      x@filtered.prey[[this.pred]] <- 
                        c(x@filtered.prey[[this.pred]], this.prey.reason)
                      
                    }
                    x@summary.prey <- 
                      x@summary.prey %>% 
                      filter(Code != this.code,
                             Prey_Code != this.code)
                    x@metaweb.filtered <- 
                      x@metaweb.filtered %>% 
                      filter(Pred_Code_new != this.code,
                             Prey_Code_new != this.code)
                  }
                  x@checklist.filtered <- 
                    x@checklist.filtered %>% 
                    filter(Code != this.code)
                  x@kept.species <- x@kept.species[x@kept.species != this.species]
                  
                  x@filtered.species <- c(x@filtered.species, this.reason)
                  cli_progress_done()
                }
                cli_alert_success("{nrow(summary.occurrence)} species removed")
              }
            } else {
              cli_alert_success("No species filtering")
            }
            x
          })

### subsample  ------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##'


setGeneric("subsample", def = function(x, ...) {
  standardGeneric("subsample") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_alert_success
setMethod('subsample', signature(x = 'trophic_dataset'),
          function(x,
                   subsample.min.prevalence,
                   subsample.max.absence) {
            # browser()
            ### Argument check and setup --------------------------------------
            args <- .filter_dataset.check.args(
              type = "subsample",
              subsample.min.prevalence = subsample.min.prevalence,
              subsample.max.absence = subsample.max.absence)
            
            for (argi in names(args)) { assign(x = argi, value = args[[argi]]) }
            
            # setup param
            x@param$param.filter$subsample.min.prevalence <- subsample.min.prevalence
            x@param$param.filter$subsample.max.absence <- subsample.max.absence
            
            # setup dir
            project.name <- x@project.name
            folder.names <- set_folder(project.name)
            for (argi in names(folder.names)) { assign(x = argi, value = folder.names[[argi]]) }
            
            # code-name converter
            listcode.full <- checklist$Code
            names(listcode.full) <- checklist$SpeciesName
            listname.full <- checklist$SpeciesName
            names(listname.full) <- checklist$Code
            
            ### Subsampling ----------------------------------------------------
            if (subsample.min.prevalence > 0 ||
                subsample.max.absence < Inf) {
              cli_h2("Subsample absences")
              cli_alert_info("Subsample absences when prevalence < {subsample.min.prevalence}\\
                     or when n(absences) > {subsample.max.absence}")
              summary.occurrence <- x@summary.occurrence %>% 
                mutate(prevalence = presence/(presence+absence)) %>% 
                filter(prevalence < subsample.min.prevalence |
                         absence > subsample.max.absence)
              if (nrow(summary.occurrence) == 0) {
                cli_alert_success("No species require subsampling")
              } else {
                for (this.species in summary.occurrence$SpeciesName) {
                  cli_progress_step(this.species)
                }
              }
              cli_alert_success("All species subsampled")
            }
            x
          })

### filter_prey  ------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##'


setGeneric("filter_prey", def = function(x, ...) {
  standardGeneric("filter_prey") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_alert_success
setMethod('filter_prey', signature(x = 'trophic_dataset'),
          function(x,
                   min.prevalence.prey,
                   min.absence.prey) {
            # browser()
            ### Argument check and setup --------------------------------------
            cli_h2("Parameter check")
            args <- .filter_dataset.check.args(
              type = "filter_prey",
              min.prevalence.prey = min.prevalence.prey,
              min.absence.prey = min.absence.prey)
            
            for (argi in names(args)) { assign(x = argi, value = args[[argi]]) }
            
            x@param$param.filter$min.prevalence.prey <- min.prevalence.prey
            x@param$param.filter$min.absence.prey <- min.absence.prey
            
            # setup dir
            project.name <- x@project.name
            folder.names <- set_folder(project.name)
            for (argi in names(folder.names)) { assign(x = argi, value = folder.names[[argi]]) }
            
            # code-name converter
            listcode.full <- checklist$Code
            names(listcode.full) <- checklist$SpeciesName
            listname.full <- checklist$SpeciesName
            names(listname.full) <- checklist$Code
            
            ### Filtering Prey -------------------------------------------------
            if (min.prevalence.prey > 0 || min.absence.prey > 0) {
              cli_h2("Filter prey")
              cli_alert_info("Remove prey with less then {min.absence.prey} absence \\
                     or a prevalence in predator presence less below {min.prevalence.prey}")
              summary.prey.rm <- 
                x@summary.prey %>% 
                filter(prevalence_pred1 < min.prevalence.prey |
                         absence < min.absence.prey)
              
              if (nrow(summary.prey.rm) == 0) {
                cli_alert_success("No predator-prey interactions to remove")
              } else {
                for (this.pred in unique(summary.prey.rm$SpeciesName)) {
                  this.summary <- filter(summary.prey.rm, SpeciesName == this.pred)
                  preycode.to.rm <- this.summary$Prey_Code
                  prey.to.rm <- listname.full[preycode.to.rm]
                  
                  this.trophic <- fread(x@file.trophic.link[this.pred])
                  for (this.prey in preycode.to.rm) {
                    this.trophic[, this.prey] <- NULL
                    this.index <- which(x@summary.predator$SpeciesName == this.pred)
                    x@summary.predator$nprey[this.index] <- 
                      x@summary.predator$nprey[this.index] - 1
                  }
                  this.file <- paste0(dataset.dir,listcode.full[this.pred],".csv.gz")
                  fwrite(this.trophic, file = this.file)  
                  x@file.trophic.link[this.pred] <- this.file
                  x@kept.prey[[this.pred]] <- 
                    x@kept.prey[[this.pred]][
                      !x@kept.prey[[this.pred]]  %in% prey.to.rm
                    ]
                  this.prey.reason <- rep("Low prey prevalence in pred. range or low prey absence count",
                                          length(prey.to.rm))
                  names(this.prey.reason) <- prey.to.rm
                  x@filtered.prey[[this.pred]] <- 
                    c(x@filtered.prey[[this.pred]], this.prey.reason)
                }
                
                x@summary.prey <- 
                  x@summary.prey %>% 
                  filter(prevalence_pred1 >= min.prevalence.prey,
                         absence >= min.absence.prey)
                
                x@metaweb.filtered <- 
                  x@metaweb.filtered %>% 
                  filter(Pred_Code_new %in% x@summary.prey$Code &
                           Prey_Code_new %in% x@summary.prey$Prey_Code)
                cli_alert_success("{nrow(summary.prey.rm)} predator-prey interactions successfully removed")
              }
            } else {
              cli_alert_success("No prey filtering")
            }
            x
          })

#### Argument Check -----------------------------------

.filter_dataset.check.args <- function(type,
                                       min.presence,
                                       min.absence,
                                       subsample.min.prevalence,
                                       subsample.max.absence,
                                       min.prevalence.prey,
                                       min.absence.prey){
  
  # Type
  if (missing(type)) {
    type <- "all"
  } else {
    .fun_testIfIn(type, c("all",
                          "filter_species",
                          "filter_prey",
                          "subsample"))
  }
  
  
  ##### filter_species ------------------------------------------------
  if (type %in% c("filter_species", "all")) {
    
    if (missing(min.presence)) {
      min.presence <- 25
      cli_alert_info("Set default min.presence = 25")
    } else {
      .fun_testIfPosInt(min.presence)
    }
    
    if (missing(min.absence)) {
      min.absence <- 25
      cli_alert_info("Set default min.absence = 25")
    } else {
      .fun_testIfPosInt(min.absence)
    }
  } else {
    min.absence <- NA
    min.presence <- NA
  }
  
  
  ##### subsample ------------------------------------------------
  if (type %in% c("subsample", "all")) {
    if (missing(subsample.min.prevalence)) {
      subsample.min.prevalence <- 0
    } else {
      .fun_testIfPosNum(subsample.min.prevalence)
    }
    
    if (missing(subsample.max.absence)) {
      subsample.max.absence <- Inf
    } else {
      if (is.finite(subsample.max.absence)) {
        .fun_testIfPosInt(subsample.max.absence)
      } else if (!is.numeric(subsample.max.absence) ||
                 subsample.max.absence < 0) {
        stop("subsample.max.absence must be a positive integer")
      }
    }
  } else {
    subsample.max.absence <- NA
    subsample.min.prevalence <- NA
  }
  
  ##### filter_prey ------------------------------------------------
  if (type %in% c("filter_prey", "all")) {
    if (missing(min.prevalence.prey)) {
      min.prevalence.prey <- 0
    } else {
      .fun_testIfPosNum(min.prevalence.prey)
    }
    
    if (missing(min.absence.prey)) {
      min.absence.prey <- 0
    } else {
      .fun_testIfPosInt(min.absence.prey)
    }
  } else {
    min.absence.prey <- NA
    min.prevalence.prey <- NA
  }
  return(list(min.presence = min.presence,
              min.absence = min.absence,
              subsample.min.prevalence = subsample.min.prevalence,
              subsample.max.absence = subsample.max.absence,
              min.prevalence.prey = min.prevalence.prey,
              min.absence.prey = min.absence.prey))
}


### load_data.trophic_dataset    --------------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##'


setGeneric("load_data", def = function(x, ...) {
  standardGeneric("load_data") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_alert_success
##' @param SpeciesName a \code{character}, a species name to retrieve data or 
##' information
##' @param Code a \code{character}, a species code to retrieve data or information
##' @param type a \code{character}, the type of data to retrieve: trophic, trophic.raw
##' occurrence

setMethod('load_data', signature(x = 'trophic_dataset'),
          function(x,
                   SpeciesName,
                   Code, 
                   type = "trophic") {
            SpeciesName <- .load_data.check.args(x = x,
                                                 SpeciesName = SpeciesName,
                                                 Code = Code,
                                                 type = type)
            if (type == "trophic") {
              df <- fread(x@file.trophic.link[SpeciesName])
            } else if (type == "trophic.raw") {
              df <- fread(x@param.raw$file.trophic.raw.link[SpeciesName])
            } else if (type == "occurrence") {
              df <- fread(x@file.occurrence.link[SpeciesName])
            }
            df
          })



### load data argument check --------------------------------------------------
.load_data.check.args <- function(x, SpeciesName, Code, type){
  
  if (missing(type)) {
    type <- "trophic"
    cli_alert_info('Retrieving trophic dataset')
  }
  
  .fun_testIfIn(type, c("trophic","occurrence","trophic.raw"))
  if (type == "trophic") {
    summary.occ <- x@summary.predator
  } else if (type == "trophic.raw") {
    summary.occ <- x@param.raw$summary.predator.raw
  } else if (type == "occurrence") {
    summary.occ <- x@summary.occurrence
  }
  
  if (!xor(missing(SpeciesName),missing(Code))) {
    stop("Exactly one of SpeciesName or Code must be given as argument")
  }
  
  
  
  if (!missing(Code)) {
    listname <- summary.occ$SpeciesName
    names(listname) <- summary.occ$Code
    if (!Code %in% summary.occ$Code) {
      stop(paste0("dataset for ", Code, " not found"))
    }
    SpeciesName <- listname[Code]
  } 
  
  if (!missing(SpeciesName)) {
    if (!SpeciesName %in% summary.occ$SpeciesName) {
      stop(paste0("dataset for ", SpeciesName, " not found"))
    }
  }
  return(SpeciesName)
}


### reset    --------------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##'


setGeneric("reset", def = function(x, ...) {
  standardGeneric("reset") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_progress_step cli_progress_done
##' 
setMethod('reset', signature(x = 'trophic_dataset'),
          function(x) {
            
            cli_progress_step("Reset trophic dataset")
            
            folder.names <- set_folder(x@project.name)
            for (argi in names(folder.names)) { 
              assign(x = argi, value = folder.names[[argi]]) 
            }
            
            x@summary.occurrence <- x@param.raw$summary.occurrence.raw
            x@summary.predator <- x@param.raw$summary.predator.raw
            x@summary.prey <- x@param.raw$summary.prey.raw
            x@metaweb.filtered <- x@param.raw$metaweb
            x@checklist.filtered <- x@param.raw$checklist
            x@kept.species <- x@param.raw$kept.species.raw
            x@filtered.species <- x@param.raw$filtered.species.raw
            x@kept.prey <- x@param.raw$kept.prey.raw
            x@filtered.prey <- x@param.raw$filtered.prey.raw
            # reset files
            file.remove(list.files(dataset.dir, full.names = TRUE))
            x@file.trophic.link <- x@param.raw$file.trophic.raw.link
            x@metaweb.filtered <- 
              x@metaweb.filtered %>% 
              filter(Pred_Code_new %in% x@summary.prey$Code &
                       Prey_Code_new %in% x@summary.prey$Prey_Code)
            
            x@checklist.filtered <- 
              x@checklist.filtered %>% 
              filter(Code %in% x@summary.occurrence$Code)
            cli_progress_done()
            x
          })



### load_data.trophic_dataset    --------------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##'


setGeneric("summary_trophic", def = function(x, ...) {
  standardGeneric("summary_trophic") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_alert_success
##' @param info the type of info return
setMethod('summary_trophic', signature(x = 'trophic_dataset'),
          function(x,
                   info = "trophic_dataset") {
            
            possible_info <- c("summary.occurrence",
                               "summary.predator",
                               "summary.prey",
                               "metaweb",
                               "checklist",
                               "kept.species",
                               "kept.prey",
                               "filtered.species",
                               "filtered.prey")
            .fun_testIfIn(info, possible_info)
            
            if (info == "summary.occurrence") {
              return(x@summary.occurrence)
            } else if (info == "summary.predator") {
              return(x@summary.predator)
            } else if (info == "summary.prey") {
              return(x@summary.prey)
            } else if (info == "metaweb") {
              return(x@metaweb.filtered)
            } else if (info == "checklist") {
              return(x@checklist.filtered)
            } else if (info == "filtered.species") {
              
              tmp <- x@filtered.species
              output <- data.frame(SpeciesName = names(tmp),
                                   reason = tmp)
              return(output)
              
            } else if (info == "filtered.prey") {
              tmp.prey <- x@filtered.prey
              output <- foreach(this.species = names(tmp.prey), .combine = 'rbind') %do% {
                tmp <- tmp.prey[[this.species]]
                if (length(tmp) == 0) {
                  return(NULL)
                }
                data.frame(Pred_Name = this.species,
                           Prey_Name = names(tmp),
                           reason = unname(tmp))
              }            
              return(output)
            } else if (info == "kept.species") {
              return(x@kept.species)
              return(output)
            } else if (info == "kept.prey") {
              return(x@kept.prey)
            }
          })

