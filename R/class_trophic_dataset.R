## --------------------------------------------------------------------------- #
# 1. trophic_dataset         ---------------------------------------------------
## --------------------------------------------------------------------------- #

##' @name trophic_dataset
##' @aliases trophic_dataset-class
##' @author Remi Patin
##'
##' @title Dataset for running trophic SDM
##'
##' @description Class returned by \code{\link{prepare_dataset_gbif}} and
##'   \code{\link{prepare_dataset_iucn}}, that prepare a dataset for a trophic
##'   SDM, based on a gbif or IUCN workflow.
##'
##' @inheritParams gbif_outsider
##' @inheritParams taxonomic_conflict
##' @inheritParams sampling_effort
##' @inheritParams rasterize_iucn
##' @param sampling.effort a \code{\link{sampling_effort}} object, generated by
##'   \code{\link{calc_sampling_effort}} containing several layers of sampling
##'   effort based on taxonomic group and the association between species and
##'   the sampling effort layer
##' @param min.gbif a \code{numeric} (\emph{default} \code{25}), the minimum
##'   number of gbif occurrences below which a species is filtered.
##' @param folder.iucn.buffer a \code{character}, folder in which IUCN buffered range
##' are stored as raster files.
##' @param quantile.absence.certain a \code{numeric} (\emph{default}
##'   \code{0.1}), between 0 and 1. The quantile of sampling effort below which
##'   a species absence is considered as uncertain
##' @param prop.prey.certain a \code{numeric} (\emph{default} \code{0.8}),
##'   between 0 and 1. The minimum proportion of prey occurrence considered as
##'   certain for a raster cell to be included in the species dataset.
##' @param uncertain.value a \code{integer} (\code{0} or \code{1} ;
##'   \emph{default} \code{0}). The value given to uncertain absences in cells
##'   where more than \code{prop.prey.certain} prey are considered as certain.
##' @param ... additional parameter given to \code{\link{filter_dataset}} to
##'   filter the dataset at the end of the workflow.
##' @param min.presence a \code{integer} used as a filtering parameter. Any 
##' species with less presence than \code{min.presence} in its trophic dataset
##' is removed.
##' @param min.absence a \code{integer} used as a filtering parameter. Any 
##' species with less absence than \code{min.absence} in its trophic dataset
##' is removed.
##' @param subsample.min.prevalence a \code{numeric} used as a subsampling
##'  parameter. Used to subsample absences in trophic dataset with prevalence below 
##'  \code{subsample.min.prevalence}.
##' @param subsample.max.absence a \code{numeric} used as a subsampling
##'  parameter. Used to subsample absences in trophic dataset with more absences 
##'  than \code{subsample.max.absence}.
##' @param min.prevalence.prey a \code{numeric} used as a filtering parameter. Any 
##' prey  with a prevalence in predator presence cell below 
##' \code{min.prevalence.prey}  is removed from the predator dataset.
##' @param min.absence.prey a \code{integer} used as a filtering parameter. Any 
##' prey less absence than \code{min.absence.prey} is removed from the predator
##'  dataset.
##' @slot summary.occurrence a \code{data.frame} with the list of species and 
##' the total number of presence and absence in the occurrence dataset extracted
##' from gbif and independently of prey cell selection.
##' @slot summary.predator a \code{data.frame} with a summary of the actual 
##' trophic dataset, i.e. list of species and the total number of presence 
##' and absence inside/outside IUCN range as well as additional information 
##' such as the number of prey.
##' @slot summary.prey a \code{data.frame} with a summary of occurrence and 
##' prevalence for all prey associated to a predator dataset.
##' @slot file.occurrence.link a named \code{vector} with a path to raw 
##' occurrence data for each species.
##' @slot file.trophic.link  a named \code{vector} with a path to filtered
##' trophic data for each species.
##' @slot file.trophic.raw.link a named \code{vector} with a path to unfiltered
##' trophic data for each species. Those files are used as a base to apply new 
##' filter rule.
##' @slot metaweb a \code{data.frame} with all original species interactions listed.
##' @slot metaweb.filtered a \code{data.frame} with all species interactions 
##' that remain after filtering of species and prey.
##' @slot checklist a \code{data.frame} with information on all species of
##'   interest
##' @slot checklist.filtered a \code{data.frame} with information on all species 
##'   that remain after filtering of species.
##' @slot kept.species a \code{character} vector with all species kept
##' @slot filtered.species a named \code{list} vector with all species removed 
##' as well as the motivation of removal
##' @slot kept.prey a named \code{list} with the prey kept for each species
##' @slot filtered.prey a named \code{list} vector with the prey removed for 
##' each species as well as the motivation of removal
##' @slot param a \code{list} with all parameters used to generate the dataset
##' @slot datatype a \code{character} determining the origin of the dataset:
##' either 'gbif' or 'iucn'.
##' @slot project.name a \code{character} indicating the folder in which
##'   logfiles and data may be written
##' @slot sampling.effort a \code{sampling_effort} object describing the sampling
##' effort associated to all taxa.
##' @slot data.mask a \code{SpatRaster} with the extent and the grid used 
##' in the project
##' 
##' @details 
##' \describe{
##'   \item{gbif dataset (\code{prepare_gbif_dataset})}{ Workflow to prepare gbif
##'   dataset}
##'   \item{IUCN dataset (\code{prepare_iucn_dataset})}{ Workflow to prepare iucn
##'   dataset}
##'   }
##' @examples
##'
##' showClass("trophic_dataset")
NULL

##' @name trophic_dataset-class
##' @rdname trophic_dataset
##' @export
##' @importFrom terra rast

## 1.1 Class Definition ----------------------------------------------------------------------------


setClass("trophic_dataset",
         representation(summary.occurrence = "data.frame",
                        summary.predator = "data.frame",
                        summary.prey = "data.frame",
                        file.occurrence.link = "character",
                        file.trophic.raw.link = "character",
                        file.trophic.link = "character",
                        metaweb = "data.frame",
                        metaweb.filtered = "data.frame",
                        checklist = "data.frame",
                        checklist.filtered = "data.frame",
                        kept.species = "character",
                        filtered.species = "character",
                        kept.prey = "list",
                        filtered.prey = "list",
                        param = "list", 
                        datatype = "character",
                        project.name = "character",
                        sampling.effort = "sampling_effort",
                        data.mask = "SpatRaster"),
         validity = function(object){
           .check_checklist(object@checklist)
           .check_checklist(object@checklist.filtered)
           .check_metaweb(object@metaweb)
           .check_metaweb(object@metaweb.filtered)
           .fun_testIfInherits(object@file.occurrence.link, "character")
           .fun_testIfInherits(object@file.trophic.link, "character")
           .fun_testIfInherits(object@kept.species, "character")
           .fun_testIfInherits(object@filtered.species, "character")
           .fun_testIfInherits(object@param, "list")
           .fun_testIfIn(obejct@datatype, c("iucn","gbif"))
           .fun_testIfInherits(object@data.mask, "SpatRaster")
           .fun_testIfInherits(object@project.name, "character")
           TRUE
         })


## 1.2 Methods -------------------------------------------------------------
### show.trophic_dataset    --------------------------------------------------
##'
##' @rdname trophic_dataset
##' @importMethodsFrom methods show
##' @param object an object of class \code{trophic_dataset}
##' @importFrom cli cli_h2 cli_h3 cli_li
##' @export
##'

setMethod('show', signature('trophic_dataset'),
          function(object)
          {
            n.removed <- length(do.call('c', object@filtered.prey))
            n.kept <- length(do.call('c', object@kept.prey))
            n.tot <- n.removed + n.kept
            percent.rm <- round(n.removed/(n.tot)*100, digits = 2)
            param <- object@param
            param.filter <- param$param.filter
            cli_h2("Trophic dataset Summary")
            cli_li("Project: {object@project.name}")
            cli_li("Species kept: {length(object@kept.species)}")
            cli_li("Species removed: {length(object@filtered.species)}")
            cli_li("Species interactions kept: {n.kept}")
            cli_li("Species interactions removed: {percent.rm}%")
            
            cli_h2("Parameters")
            cli_h3("Species Filtering")
            cli_li("Minimum gbif occurrences = {param$min.gbif}")
            cli_li("Quantile used for evaluating absences as certain = {unique(param$quantile.absence.certain)}")
            cli_li("Minimum presence = {param.filter$min.presence}")
            cli_li("Minimum absence  = {param.filter$min.absence}")
            
            cli_h3("Prey filtering")
            cli_li("Minimum prey absence  = {param.filter$min.absence.prey}")
            cli_li("Minimum prey prevalence in predator presence cells  = {param.filter$min.prevalence.prey}")
            
            cli_h3("Predator cell selection")
            cli_li("Required proportion of certain prey occurrences = {param$prop.prey.certain*100}%")
            cli_li("Values for uncertain prey cells = {param$uncertain.value}")
            
            cli_h3("Subsampling absences")
            cli_li("Minimum prevalence = {param.filter$subsample.min.prevalence}")
            cli_li("Maximum number of absences = {param.filter$subsample.max.absence}")
            invisible(NULL)
          })




### filter_dataset.trophic_dataset    --------------------------------------------------
##'
##' @rdname trophic_dataset
##' @param x an object of class \code{trophic_dataset}
##' @export
##'


setGeneric("filter_dataset", def = function(x, ...) {
  standardGeneric("filter_dataset") 
})

##' @rdname trophic_dataset
##' @export
##' @importFrom cli cli_alert_success
setMethod('filter_dataset', signature(x = 'trophic_dataset'),
          function(x,
                   min.presence,
                   min.absence,
                   subsample.min.prevalence,
                   subsample.max.absence,
                   min.prevalence.prey,
                   min.absence.prey) {
            # browser()
            ### Argument check and setup --------------------------------------
            args <- .filter_dataset.check.args(min.presence = min.presence,
                                               min.absence = min.absence,
                                               subsample.min.prevalence = subsample.min.prevalence,
                                               subsample.max.absence = subsample.max.absence,
                                               min.prevalence.prey = min.prevalence.prey,
                                               min.absence.prey = min.absence.prey)
            
            for (argi in names(args)) { assign(x = argi, value = args[[argi]]) }
            
            # browser()
            # setup param
            x@param$param.filter$min.presence <- min.presence
            x@param$param.filter$min.absence <- min.absence
            x@param$param.filter$subsample.min.prevalence <- subsample.min.prevalence
            x@param$param.filter$subsample.max.absence <- subsample.max.absence
            x@param$param.filter$min.prevalence.prey <- min.prevalence.prey
            x@param$param.filter$min.absence.prey <- min.absence.prey
            
            # setup dir
            project.name <- x@project.name
            dataset.dir <- paste0(project.name, "/trophic_dataset/")
            if (!dir.exists(dataset.dir)) dir.create(dataset.dir, recursive = TRUE, showWarnings = FALSE)
            raw.dir <- paste0(project.name, "/trophic_dataset_raw/")
            if (!dir.exists(raw.dir)) dir.create(raw.dir, recursive = TRUE, showWarnings = FALSE)
            occurrence.dir <- paste0(project.name, "/occurrence_dataset/")
            if (!dir.exists(occurrence.dir)) dir.create(occurrence.dir, recursive = TRUE, showWarnings = FALSE)
           
            # reset files
            file.remove(list.files(dataset.dir, full.names = TRUE))
            x@file.trophic.link <- x@file.trophic.raw.link
            
            # code-name converter
            listcode.full <- checklist$Code
            names(listcode.full) <- checklist$SpeciesName
            listname.full <- checklist$SpeciesName
            names(listname.full) <- checklist$Code
            
            # browser()
            ### Filtering Species ----------------------------------------------
            if (min.presence > 0 || min.absence > 0) {
              cli_h2("Filter species")
              cli_alert_info("Remove species with less then {min.presence} presence \\
                     or less than {min.absence} absence")
              summary.occurrence <- x@summary.occurrence %>% 
                filter(presence < min.presence |
                         absence < min.absence)
              if (nrow(summary.occurrence) == 0){
                cli_alert_success("No species require subsampling")
              } else {
                for(this.species in summary.occurrence$SpeciesName){
                  cli_progress_step("Removing {this.species}")
                  this.reason <- "Not enough data after rasterization"
                  names(this.reason) <- this.species
                  this.code <- listcode.full[this.species]
                  
                  x@summary.occurrence <- 
                    x@summary.occurrence %>% 
                    filter(SpeciesName != this.species)
                  
                  x@summary.predator <- 
                    x@summary.predator %>% 
                    filter(SpeciesName != this.species)
                  
                  # Remove species in predator dataset
                  summary.prey.rm <-  
                    x@summary.prey %>% 
                    filter(Prey_Code == this.code)
                  if (nrow(summary.prey.rm) > 0) {
                    for (this.pred in summary.prey.rm$SpeciesName) {
                      this.trophic <- fread(x@file.trophic.link[this.pred])
                      this.trophic[, this.code] <- NULL
                      this.index <- which(x@summary.predator$SpeciesName == this.pred)
                      x@summary.predator$nprey[this.index] <- 
                        x@summary.predator$nprey[this.index] -1
                      this.file <- paste0(dataset.dir,this.code,".csv.gz")
                      fwrite(this.trophic, file = this.file)  
                      x@file.trophic.link[this.pred] <- this.file
                      x@kept.prey[[this.pred]] <- 
                        x@kept.prey[[this.pred]][
                          x@kept.prey[[this.pred]] != this.species
                        ]
                      this.prey.reason <- "Not enough data after rasterization"
                      names(this.prey.reason) <- this.species
                      x@filtered.prey[[this.pred]] <- 
                        c(x@filtered.prey[[this.pred]], this.prey.reason)
                      
                    }
                  }
                  x@summary.prey <- 
                    x@summary.prey %>% 
                    filter(Code != this.code,
                           Prey_Code != this.code)
                  x@metaweb.filtered <- 
                    x@metaweb.filtered %>% 
                    filter(Pred_Code_new != this.code,
                           Prey_Code_new != this.code)
                  x@checklist.filtered <- 
                    x@checklist.filtered %>% 
                    filter(Code != this.code)
                  
                  x@kept.species <- x@kept.species[x@kept.species != this.species]
                  
                  x@filtered.species <- c(x@filtered.species, this.reason)
                  cli_progress_done()
                }
                cli_alert_success("{nrow(summary.occurrence$SpeciesName)} species removed")
                
              }
              
            }
            # browser()
            
            ### Subsampling ----------------------------------------------------
            if (subsample.min.prevalence > 0 ||
                subsample.max.absence < Inf) {
              cli_h2("Subsample absences")
              cli_alert_info("Subsample absences when prevalence < {subsample.min.prevalence}\\
                     or when n(absences) > {subsample.max.absence}")
              summary.occurrence <- x@summary.occurrence %>% 
                mutate(prevalence = presence/(presence+absence)) %>% 
                filter(prevalence < subsample.min.prevalence |
                         absence > subsample.max.absence)
              if (nrow(summary.occurrence) == 0){
                cli_alert_success("No species require subsampling")
              } else {
                for(this.species in summary.occurrence$SpeciesName){
                  cli_progress_step(this.species)
                }
              }
              cli_alert_success("All species subsampled")
            }
            # browser()
            
            ### Filtering Prey -------------------------------------------------
            if (min.prevalence.prey > 0 || min.absence.prey > 0) {
              cli_h2("Filter prey")
              cli_alert_info("Remove prey with less then {min.absence.prey} absence \\
                     or a prevalence in predator presence less below {min.prevalence.prey}")
              summary.prey.rm <- 
                x@summary.prey %>% 
                filter(prevalence_pred1 < min.prevalence.prey |
                       absence < min.absence.prey)
              
              if (nrow(summary.prey.rm) == 0) {
                cli_alert_success("No predator-prey interactions to remove")
              } else {
                for (this.pred in unique(summary.prey.rm$SpeciesName)) {
                  this.summary <- filter(summary.prey.rm, SpeciesName == this.pred)
                  preycode.to.rm <- this.summary$Prey_Code
                  prey.to.rm <- listname.full[preycode.to.rm]
                  
                  this.trophic <- fread(x@file.trophic.link[this.pred])
                  for (this.prey in preycode.to.rm) {
                    this.trophic[, this.prey] <- NULL
                    this.index <- which(x@summary.predator$SpeciesName == this.pred)
                    x@summary.predator$nprey[this.index] <- 
                      x@summary.predator$nprey[this.index] - 1
                  }
                  this.file <- paste0(dataset.dir,this.code,".csv.gz")
                  fwrite(this.trophic, file = this.file)  
                  x@file.trophic.link[this.pred] <- this.file
                  x@kept.prey[[this.pred]] <- 
                    x@kept.prey[[this.pred]][
                      ! x@kept.prey[[this.pred]]  %in% prey.to.rm
                    ]
                  this.prey.reason <- rep("Low prey prevalence in pred. range or low prey absence count",
                                          length(prey.to.rm))
                  names(this.prey.reason) <- prey.to.rm
                  x@filtered.prey[[this.pred]] <- 
                    c(x@filtered.prey[[this.pred]], this.prey.reason)
                }
                
                x@summary.prey <- 
                  x@summary.prey %>% 
                  filter(prevalence_pred1 >= min.prevalence.prey,
                         absence >= min.absence.prey)
                
                x@metaweb.filtered <- 
                  x@metaweb.filtered %>% 
                  filter(Pred_Code_new %in% x@summary.prey$Code &
                           Prey_Code_new %in% x@summary.prey$Prey_Code)
                cli_alert_success("{nrow(summary.prey.rm)} predator-prey interactions successfully removed")
              }
            }
            x
          })


#### Argument Check -----------------------------------

.filter_dataset.check.args <- function(min.presence,
                                       min.absence,
                                       subsample.min.prevalence,
                                       subsample.max.absence,
                                       min.prevalence.prey,
                                       min.absence.prey){
  ##### min.presence ------------------------------------------------
  if (missing(min.presence)) {
    min.presence <- 25
    cli_alert_info("Set default min.presence = 25")
  } else {
    .fun_testIfPosInt(min.presence)
  }
  
  ##### min.absence ------------------------------------------------
  if (missing(min.absence)) {
    min.absence <- 25
    cli_alert_info("Set default min.absence = 25")
  } else {
    .fun_testIfPosInt(min.absence)
  }
  
  ##### subsample.min.prevalence ------------------------------------------------
  if (missing(subsample.min.prevalence)) {
    subsample.min.prevalence <- 0
  } else {
    .fun_testIfPosNum(subsample.min.prevalence)
  }
  
  ##### subsample.max.absence ------------------------------------------------
  if (missing(subsample.max.absence)) {
    subsample.max.absence <- Inf
  } else {
    if( is.finite(subsample.max.absence) ){
      .fun_testIfPosInt(subsample.max.absence)
    } else if (!is.numeric(subsample.max.absence) ||
               subsample.max.absence < 0) {
      stop("subsample.max.absence must be a positive integer")
    }
  }
  
  ##### min.prevalence.prey ------------------------------------------------
  if (missing(min.prevalence.prey)) {
    min.prevalence.prey <- 0
  } else {
    .fun_testIfPosNum(min.prevalence.prey)
  }
  
  ##### min.absence.prey ------------------------------------------------
  if (missing(min.absence.prey)) {
    min.absence.prey <- 0
  } else {
    .fun_testIfPosInt(min.absence.prey)
  }
  
  return(list(min.presence = min.presence,
              min.absence = min.absence,
              subsample.min.prevalence = subsample.min.prevalence,
              subsample.max.absence = subsample.max.absence,
              min.prevalence.prey = min.prevalence.prey,
              min.absence.prey = min.absence.prey))
}
